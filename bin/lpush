#!/bin/bash

bindir=$(dirname $0)

p=~/b/om/p
l=~/b/om/l
if [[ ! -d "$p" ]]; then
    mkdir -p "$p"
fi
if [[ ! -d "$l" ]]; then
    mkdir -p "$l"
fi

if [[ ! -d "$p/CRUZER" ]]; then
    $bindir/vmount || exit 1
fi
p=$p/CRUZER

if [[ -d '/Volumes/Hosta!host!/CRUZER' ]]; then
  ln -sf '/Volumes/Hosta!host!/CRUZER' "$l/CRUZER"
elif [[ -d '/Volumes/LVCRUZER/CRUZER' ]]; then
  ln -sf '/Volumes/LVCRUZER/CRUZER' "$l/CRUZER"
fi
l=$l/CRUZER


printf "Push $p/CRUZER/ ---> $l/CRUZER/ ? (y/n): "
read yesno
if [[ $yesno != 'y' ]]; then
  exit 1
else
    printf "Are you sure? (YES/no): "
    read yesno
    if [[ $yesno != 'YES' ]]; then
      echo
      echo "I assume you are not sure then ..."
      echo
      exit 1
    fi
fi

echo
echo "Syncing ..."
cmd="TZ=UTC rsync -a --delete $p/CRUZER/ $l/CRUZER/"
echo "doing: $cmd"
bash -c "$cmd"

lastsync=$(date "+lastsync--%Y-%m-%d--%H-%M-%S")
(cd $l/.. && (rm -f lastsync*; touch $lastsync))
