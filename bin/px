#!/bin/bash

set -x

nucip='192.168.10.180'
ping -n 1 $nucip >/dev/null 2>&1 || nucip='76.236.30.161'


umask 077
rm -rf ~/.ssh/x
mkdir -p ~/.ssh/x
ssh-keygen -t ed25519 -N '' -f ~/.ssh/x/id_ed25519

cat <<EOF >~/.ssh/x/config
StrictHostKeyChecking=no
CheckHostIP=no
EscapeChar=~
UserKnownHostsFile=/dev/null
LogLevel ERROR

Host nuc
    User om
    HostName $nucip
    IdentityFile ~/.ssh/x/id_ed25519
    GatewayPorts true
    LocalForward 3128 localhost:3128

EOF

ssh='ssh -F '$HOME/.ssh/x/config
scp='scp -F '$HOME/.ssh/x/config
$scp $HOME/.ssh/x/id_ed25519.pub nuc:.ssh/authorized_keys
$scp nuc:.ssh/fash/id_ed25519 ~/.ssh/x/id_ed25519.fash
faship=$($ssh nuc 'cat .ssh/config.d/fash' | grep Hostname|awk '{print $2}')

cat <<EOF >>~/.ssh/x/config

Host nucback
    User om
    HostName $nucip
    IdentityFile ~/.ssh/x/id_ed25519
    GatewayPorts true
    LocalForward 3128 localhost:3128
    LocalForward 2222 $faship:22
    LocalForward 2282 192.168.10.182:22
    LocalForward 2280 192.168.10.180:22
    RequestTTY no
    RemoteCommand cat

Host fashback
    User om
    HostName localhost
    IdentityFile ~/.ssh/x/id_ed25519.fash
    Port 2222
    GatewayPorts true
    LocalForward 3129 localhost:3128
    RequestTTY no
    RemoteCommand cat
EOF

$ssh nucback >/dev/null 2>&1 &
$ssh fashback >/dev/null 2>&1 &

