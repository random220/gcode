#!/bin/bash

export PATH=$HOME/bin:$HOME/gcode/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
vera_volume=/b/om/CRUZER.vol
mountpoint=/b/om/p

veracrypt='veracrypt'
uname=$(uname)
if [[ $uname == 'Darwin' ]]; then
  veracrypt='/Applications/VeraCrypt.app/Contents/MacOS/VeraCrypt'
fi

if [[ ! -f $vera_volume ]]; then
  echo "Error: File not found: $vera_volume"
  exit 1
fi
if [[ ! -d $mountpoint ]]; then
  echo "Error: Mountpoint dir does not exist: $mountpoint"
  exit 1
fi

$veracrypt --text --version >/dev/null 2>&1
if [[ $? != 0 ]]; then
  echo "Error: veracrypt not found"
  exit 1
fi

mount | egrep "veracrypt.* $mountpoint " >/dev/null 2>&1
if [[ $? == 0 ]]; then 
  # Already mounted. Say so.
  echo "Something is already mounted on $mountpoint"
  exit 0
fi

$veracrypt --text --keyfiles='' --pim=0 --protect-hidden=no $vera_volume $mountpoint
$veracrypt --text --list 2>&1 | tee /tmp/vmounts.txt
# 1: /b/om/CRUZER.vol /dev/disk4 /b/om/p
# 2: /Volumes/3TB/om/LCRUZER.vol /dev/disk5 /b/om/l

egrep -q " $vera_volume .* $mountpoint" /tmp/vmounts.txt
result=$?
rm -f /tmp/vmounts.txt

exit $result




