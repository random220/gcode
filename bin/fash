#!/bin/bash

set -x
umask 077
rm -rf ~/.ssh/fash
mkdir -p ~/.ssh/fash
cd ~/.ssh/fash
ssh-keygen -t ed25519 -N '' -f id_ed25519
cat id_ed25519.pub | multipass exec favpn bash -- -c 'cat - >/tmp/a.txt'

cat <<'EOF' |  multipass exec favpn bash -
umask 077
sudo mkdir -p ~om/.ssh
sudo mv /tmp/a.txt ~om/.ssh/authorized_keys
sudo chown -R om:om ~om/.ssh
EOF

ipaddr=$(multipass ls |grep favpn|grep Ubuntu|awk '{print $3}')

mkdir -p ~/.ssh/config.d
cat <<EOF >~/.ssh/config.d/fash
StrictHostKeyChecking=no
CheckHostIP=no
EscapeChar=~
UserKnownHostsFile=/dev/null
LogLevel ERROR


Host favpn fash
    User om
    Hostname $ipaddr
    IdentityFile ~/.ssh/fash/id_ed25519
EOF

grep 'Include ~/\.ssh/config.d/\*' ~/.ssh/config
if [[ $? != 0 ]]; then
    echo 'Include ~/.ssh/config.d/*' >~/.ssh/config.new
    cat ~/.ssh/config >>~/.ssh/config.new
    mv ~/.ssh/config.new ~/.ssh/config
fi
ssh favpn

