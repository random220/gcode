#!/bin/bash
vmrun='/Applications/VMware Fusion.app/Contents/Library/vmrun'
vmx_vstart=/Users/omandal/b/VMs/ub24-luks.vmwarevm/ub24-luks.vmx
vmx_uvstart=/Users/omandal/b/VMs/ub24-v.vmwarevm/ub24-v.vmx
myname=$(basename $0)
vmx=$(eval "echo \$vmx_$myname")

"$vmrun" start "$vmx"
ip=''
n=0
while true; do
    n=$(( n + 1 ))
    if [[ $n == 9 ]]; then
        echo 'Timed out'
        exit 1
    fi
    ip=$("$vmrun" getGuestIPAddress "$vmx")
    if [[ "$ip" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        break
    else
        sleep 5
    fi
done

out=$(
cat <<EOF
v=om@$ip
ssh -L 3131:localhost:3131 \$v
EOF
)
pbcopy <<<"$out"
echo "$out"
echo 'vmount'
echo 'cd ~/b/om/p/CRUZER && pyweb 3131'
