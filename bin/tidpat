#!/usr/bin/env python3

import sys, os
import glob
import getpass

home = os.environ['HOME']
look = [
  f'{home}/Desktop/tiddly*.html',
  f'{home}/Downloads/tiddly*.html',
  f'{home}/tiddly*.html',
  f'./tiddly*.html',
]
found = []




def main():
  decide_on_file()

def do_things(f):
  pw = getpass.getpass()
  os.environ['mypass'] = pw

  print(f'File used: "{f}"')
  os.system(f'rm -rf _xx')
  os.system(f'genc -t _xx -d {home}/b/om/tiddly.html.gpg')
  if os.path.isfile("_xx/tiddly.html.gpg.plain"):
    os.system(f'diff -w _xx/tiddly.html.gpg.plain "{f}" >_xx/diff')
    os.system('gzip _xx/diff')
    os.system(f'rm -f _xx/tiddly.html.gpg.plain')

    os.system(f'genc -t _xx "{f}"')

    if os.path.isfile('_xx/tiddly.html.gpg'):
      os.system(f'rm -f "{f}"')
    else:
      print(f'Failed to encrypt "{f}"')
      sys.exit(1)
  else:
    print(f'Failed to decrypt "{f}"')
    sys.exit(1)

  print('''

#TODO
cp _xx/tiddly.html.gpg ~/b/om
scp _xx/diff.gz cron:.
rm -rf _xx/

ssh cron
vmount
cp ~/b/om/p/CRUZER/gitted/sandbox/tiddly.html .
gunzip diff.gz
patch tiddly.html <diff
#tt or ttc
rm -f diff
vumount

''')

def decide_on_file():
  look2 = []
  for pattern in look:
    look2.extend(glob.glob(pattern))

  timestamp_last = 0
  for f in look2:
    if os.path.exists(f):
      timestamp_now = os.path.getmtime(f)
      if timestamp_last > timestamp_now:
        found.append(f)
      else:
        # add at the first position of the list found
        found.insert(0, f)
      timestamp_last = timestamp_now

  if len(found) == 0:
    pass
  elif len(found) == 1:
    latest_file = found[0]
    do_things(latest_file)
  else:
    latest_file = found[0]
    print('Multiple files found:')
    print(f'Shall we use the latest one ({latest_file})')
    print('and delete the rest?')
    for f in found[1:]:
      print(f'    {f}')
    print('? [y/n]')
    answer = input()
    if answer == 'y':
      for f in found[1:]:
        os.unlink(f)
      os.system(f'mv "{latest_file}" ~/Downloads/tiddly.html')
      do_things(os.environ['HOME']+'/Downloads/tiddly.html')
    else:
      print('No file was used.')
  
main()
