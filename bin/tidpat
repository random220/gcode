#!/usr/bin/env python3

import sys, os
import glob

home = os.environ['HOME']
look = [
  f'{home}/Downloads/tiddly*.html',
  f'{home}/tiddly*.html',
  f'./tiddly*.html',
]
found = []




def main():
  decide_on_file()

def do_things(f):
  print(f'File used: {f}')
  os.system(f'rm -rf _xx')
  os.system(f'genc -t _xx -d {home}/b/om/tiddly.html.gpg')
  os.system(f'diff -w _xx/tiddly.html.gpg.plain "{f}" >_xx/diff')
  os.system('gzip _xx/diff')
  os.system(f'rm -f _xx/tiddly.html.gpg.plain')

  os.system(f'genc -t _xx {f}')
  os.system(f'rm -f {f}')

  print('')
  print('#TODO')
  print('cp _xx/tiddly.html.gpg ~/b/om')
  print('scp _xx/diff.gz cron:.')
  print('rm -rf _xx/')
  print('')
  print('ssh cron')
  print('cp ~/b/om/p/CRUZER/gitted/sandbox/tiddly.html .')
  print('gunzip diff.gz')
  print('patch tiddly.html <diff')
  print('#tt or ttc')
  print('rm -f diff')
  print('vumount')
  print('')

def decide_on_file():
  look2 = []
  for pattern in look:
    look2.extend(glob.glob(pattern))

  timestamp_last = 0
  for f in look2:
    if os.path.exists(f):
      timestamp_now = os.path.getmtime(f)
      if timestamp_last > timestamp_now:
        found.append(f)
      else:
        # add at the first position of the list found
        found.insert(0, f)
      timestamp_last = timestamp_now

  if len(found) == 0:
    pass
  elif len(found) == 1:
    latest_file = found[0]
    do_things(latest_file)
  else:
    latest_file = found[0]
    print('Multiple files found:')
    print(f'Shall we use the latest one ({latest_file})')
    print('and delete the rest?')
    for f in found[1:]:
      print(f'    {f}')
    print('? [y/n]')
    answer = input()
    if answer == 'y':
      for f in found[1:]:
        os.unlink(f)
      do_things(latest_file)
    else:
      print('No file was used.')
  
main()
