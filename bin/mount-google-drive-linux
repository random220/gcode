#!/bin/bash

myname=$(basename "$0")

main() {
    if [[ "$1" != '' ]]; then
        help
        exit
    else
        doit
    fi
}

help() {
cat <<'EOF'

# better auth
# https://github.com/astrada/google-drive-ocamlfuse/wiki/Authorization

## cid='12345678.apps.googleusercontent.com'
## sec='abcde12345'
## google-drive-ocamlfuse -id "$cid" -secret "$sec"
##
## To create client id and client secret
## https://console.cloud.google.com/

1. Create a "project": https://console.cloud.google.com/projectcreate  # Name it om-gdfuse-33, no org

2. Go back to dashboard. This is your home screen. When lost, come here:
       https://console.cloud.google.com/home/dashboard?project=om-gdfuse-33

3. We are trying to give this project access to google drive APIs, so, scroll down while looking left
   Look for "Explore and enable APIs"
   https://console.cloud.google.com/apis/dashboard?project=om-gdfuse-33

4. Need to create an App-ID and secret. Which means, credentials. On the left side, click on "Credentials"
   You will need to hit "CONFIGURE CONSENT SCREEN"
       Click "External" (Internal costs money)
       Fill out only required stuff. app name and email address in two places
       (scope?)
       Save and continue

       Add yourself as a "Test user"
       Save and continue (disregard error that you are not eligible as a test user)

       Do NOT click "BACK TO DASHBOARD"
       Click "Credentials" on the left side again

       On the top middle hit "CREATE CREDENTIALS"
           Choose "OAuth Client ID"
           Application type "Desktop App"

5. OK, you got an id and a password. But it has no power. You need to give it powers to use certain APIs.
   Go back to https://console.cloud.google.com/apis/dashboard?project=om-gdfuse-33
   Hit "ENABLE APIS AND SERVICES" on the top middle of the screen
   In search are type drive and hit enter
   Choose "Google Drive API"
   Hit "Enable"

## (Delete from Project Settings windos
##        https://console.cloud.google.com/iam-admin/settings?project=om-gdfuse-25730
## )

# original doc
# https://medium.com/@enthu.cutlet/how-to-mount-google-drive-on-linux-windows-systems-5ef4bff24288

sudo add-apt-repository ppa:alessandro-strada/ppa
sudo apt update && sudo apt install google-drive-ocamlfuse

google-drive-ocamlfuse

mkdir ~/G
google-drive-ocamlfuse ~/G
fusermount -u ~/G





EOF
}

doit() {
type google-drive-ocamlfuse >/dev/null 2>&1
if [[ $? != 0 ]]; then
    echo
    echo "Need to install google-drive-ocamlfuse"
    echo
    sudo add-apt-repository -y ppa:alessandro-strada/ppa
    sudo apt-get -y update
    sudo apt-get -y install google-drive-ocamlfuse
fi

mkdir -p ~/G
if [[ "$myname" == 'greg' ]]; then
    if [[ ! -f ~/.ssh/cid ]]; then
        echo Need app id in ~/.ssh/cid
        echo "Download from https://console.cloud.google.com/apis/credentials?project=om-gd-410505"
        echo
        exit
    fi
    if [[ ! -f ~/.ssh/sec ]]; then
        echo Need app secret in ~/.ssh/sec
        echo "Download from https://console.cloud.google.com/apis/credentials?project=om-gd-410505"
        echo
        exit
    fi
    cid=$(cat ~/.ssh/cid)
    sec=$(cat ~/.ssh/sec)
    rm -rf ~/.gdfuse
    google-drive-ocamlfuse -id "$cid" -secret "$sec"
elif [[ "$myname" == 'gmount' ]]; then
    if [[ ! -d ~/.gdfuse ]]; then
        greg
    fi
    google-drive-ocamlfuse ~/G
elif [[ "$myname" == 'gumount' ]]; then
    fusermount -u ~/G
else
    echo
    echo "Application name should be gmount or gumount"
    echo
    exit 1
fi
}

main "$@"


