#!/bin/bash
volname=CRUZER
vol=~/b/om/$volname-LUKS.vol 
if [[ -f $vol ]]; then
    echo "Error: $vol exists"
    exit 1
fi

mountpoint=~/b/om/p/$volname
mkdir -p $mountpoint


# reserve 30gigs
truncate -s 30G $vol

# Attach to a loop device
sudo losetup -fP $vol
# -f finds the first free loop device (likely /dev/loop8 in your case, but it could be higher).
# -P ensures partitions are recognized.

# check which loop device was assigned
losetup -j $vol
# /dev/loop8: []: (/home/om/b/om/$volname-LUKS.vol)

loopdevice=$(losetup -j $vol|sed 's/:.*//')
# /dev/loop8

# Initialize LUKS on the assigned loop device
sudo cryptsetup luksFormat $loopdevice
# THIS ASKS FOR PASSWORD TWICE AND DOES STUFF THAT TAKES LIKE HALF A MINUTE

# Then continue with opening, formatting, and mounting
sudo cryptsetup luksOpen /dev/loop8 $volname  # ASKS THE SAME PASSWORD

# The reverse of cryptsetup luksOpen is cryptsetup luksClose. The luksOpen
# command maps a LUKS-encrypted device to a decrypted virtual device (e.g.,
# /dev/mapper/encrypted_volume), and luksClose removes this mapping, effectively
# locking the encrypted container so its contents are no longer accessible.


sudo mkfs.ext4 /dev/mapper/$volname
sudo mount /dev/mapper/$volname $mountpoint

# umount
cat <<EOF
sudo umount $mountpoint
sudo cryptsetup luksClose $volname
sudo losetup -d $loopdevice
EOF

