#!/bin/bash

arg=$1

echo "Destination: /b/om/p/CRUZER/gitted/sandbox"

set_comment() {
  myname=$(basename $0)
  comment='checkpoint'
  if [[ $myname == 'ttc' ]]; then
    printf "Comment: "
    read comment
  fi
}

main() {
  do_tiddly
  do_mint
}

do_mint() {
  file_new1=$HOME/Downloads/transactions.csv
  file_new2=$HOME/Desktop/transactions.csv

  file_new=$file_new1
  if [[ ! -f $file_new ]]; then
    file_new=$file_new2
  fi
  if [[ ! -f $file_new ]]; then
    echo "Not found: $file_new1"
    echo "Not found: $file_new2"
    return
  fi
  file_forever='/b/om/p/CRUZER/gitted/sandbox/mint-transactions.csv'
  diff -q $file_new $file_forever >/dev/null 2>&1
  if [[ $? == 0 ]]; then
    # no diff
    echo "rm -f $file_new"
    rm -f $file_new
    return
  fi
  mv $file_new $file_forever
  (
    cd /b/om/p/CRUZER/gitted/sandbox
    git add mint-transactions.csv
    datestring=$(date "+%Y-%m-%d %H:%M:%S")
    git commit -m "mint $datestring"
  )
}

do_tiddly() {
  tiddly_new1=$HOME/Downloads/tiddly.html
  tiddly_new2=$HOME/Documents/tiddly.html
  tiddly_new3=$HOME/Desktop/tiddly.html
  tiddly_new4=/b/om/p/tmp/chrome-downloads/tiddly.html

  if [[ -f $tiddly_new1 ]]; then
    tiddly_new=$tiddly_new1
  elif [[ -f $tiddly_new2 ]]; then
    tiddly_new=$tiddly_new2
  elif [[ -f $tiddly_new3 ]]; then
    tiddly_new=$tiddly_new3
  elif [[ -f $tiddly_new4 ]]; then
    tiddly_new=$tiddly_new4
  else
    tiddly_new='_none_'
  fi

  if [[ $tiddly_new == '_none_' ]]; then
    echo "Not found: $tiddly_new1"
    echo "Not found: $tiddly_new2"
    echo "Not found: $tiddly_new3"
    echo "Not found: $tiddly_new4"
    return
  fi

  tiddly_forever='/b/om/p/CRUZER/gitted/sandbox/tiddly.html'
  if [[ ! -f $tiddly_forever ]]; then
    echo "Not found: $tiddly_forever"
    echo "Consider rm -f $tiddly_new"
  else
    ls -ld $tiddly_new $tiddly_forever
    cmd="mv $tiddly_new $tiddly_forever"
    printf "todo: $cmd\\n"
    if [[ $arg == '' ]]; then
      echo "Doing it"
      eval $cmd
    fi
    set_comment
    cmd="(cd /b/om/p/CRUZER/gitted/sandbox && (git add tiddly.html; git commit -m '$comment'))"
    printf "todo: $cmd\\n"
    if [[ $arg == '' ]]; then
      echo "Doing it"
      eval $cmd
    fi
  fi
}

main
