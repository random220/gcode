#!/bin/bash

arg=$1

tiddly_forever=~/b/om/p/CRUZER/CRUZER/gitted/sandbox/tiddly.html
if [[ ! -f "$tiddly_forever" ]]; then
  echo "ERROR: Not found \"$tiddly_forever\""
  exit 1
fi
echo "Destination File: $tiddly_forever"

set_comment() {
  myname=$(basename $0)
  comment='checkpoint'
  if [[ $myname == 'ttc' ]]; then
    printf "Comment: "
    read comment
  fi
}

main() {
  do_tiddly
}

do_tiddly() {
  tmpdir=$(mktemp -d)
  ls -1tr \
  $HOME/Downloads/tiddly*.html \
  $HOME/Documents/tiddly*.html \
  $HOME/Desktop/tiddly*.html \
  $HOME/tiddly*.html \
  $p/tmp/chrome-downloads/tiddly*.html \
  >$tmpdir/tiddlies.txt 2>/dev/null

  tiddly_new='_none_'
  n=$(wc -l $tmpdir/tiddlies.txt | awk '{print $1}')
  if [[ $n == 0 ]]; then
    :
  elif [[ $n == 1 ]]; then
    tiddly_new=$(tail -1 $tmpdir/tiddlies.txt)
  else
    echo "You have more than one tiddlies"
    echo
    cat $tmpdir/tiddlies.txt
    echo
    echo -n 'Proceed with the last one? [y/n] '
    read ans
    if [[ $ans == 'y' ]]; then
      tiddly_new=$(tail -1 $tmpdir/tiddlies.txt)
    else
      echo
      echo -n 'Delete all? [y/n] '
      read ans
      if [[ $ans == 'y' ]]; then
        cat $tmpdir/tiddlies.txt | perl -pe 's/\n/\0/s' | xargs -0 rm
      fi
    fi
  fi

  if [[ $tiddly_new == '_none_' ]]; then
    echo "No tiddly found"
    rm -rf $tmpdir
    return
  fi

  ls -ld "$tiddly_new" "$tiddly_forever"
  cmd="cp \"$tiddly_new\" \"$tiddly_forever\""
  printf "todo: $cmd\\n"
  if [[ $arg == '' ]]; then
    echo "Doing it"
    eval $cmd
  fi
  set_comment
  tdir=$(dirname "$tiddly_forever")
  cmd="(cd $tdir && (git add tiddly.html; git commit -m '$comment'))"
  printf "todo: $cmd\\n"
  if [[ $arg == '' ]]; then
    echo "Doing it"
    eval $cmd
  fi

  cat $tmpdir/tiddlies.txt | perl -pe 's/\n/\0/s' | xargs -0 rm
  rm -rf $tmpdir
}

main
