#!/bin/bash

#set -x

bitrate=320
if [[ "$1" =~ ^[0-9]+$ ]]; then
    bitrate=$1
    shift
fi

showhelp() {
    echo "$0 320 a.flac"
    echo 'ffmpeg -i a.flac -ab 320k -map_metadata 0 -id3v2_version 3 a.mp3'
}

to_mp3() {
    local bit="$1"
    local infile="$2"
    local outfile=$(perl -pe 's{\.[^\.]+$}{.mp3}; s{^.*/}{}; s{^}{mp3/}' <<<"$infile")
    echo "ffmpeg -i \"$infile\" -ab ${bit}k -map_metadata 0 -id3v2_version 3 \"$outfile\""
}

echo 'mkdir -p mp3'
for flacfile in "$@"; do
    if [[ -f "$flacfile" ]]; then
        to_mp3 $bitrate "$flacfile"
    fi
done
