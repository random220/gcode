#!/bin/bash

# ~/.ssh/config
# Host home_dns
#     User om
#     Hostname crondite.duckdns.org
#     IdentityFile ~/.ssh/id_rsa
# 
# Host home_localip
#     User om
#     Hostname 192.168.10.180
#     IdentityFile ~/.ssh/id_rsa
# 
cp -p -f ~/.ssh/config ~/.ssh/config.000
cat > ~/.ssh/config <<EOF
StrictHostKeyChecking=no
CheckHostIP=no
EscapeChar=~
UserKnownHostsFile=/dev/null

Host home_dns
    User om
    Hostname crondite.duckdns.org
    IdentityFile ~/.ssh/id_rsa

Host home_localip
    User om
    Hostname 192.168.10.180
    IdentityFile ~/.ssh/id_rsa
EOF

bindir=$(dirname $0)
target_machine='home_dns'
ifconfig -a|egrep 'inet .*192\.168\.10\.' >/dev/null 2>&1
if [[ $? == 0 ]]; then
  target_machine='home_localip'
fi

printf "Push to $target_machine? (y/n): "
read yesno
if [[ $yesno != 'y' ]]; then
  exit 1
fi

/usr/bin/ssh-copy-id -i ~/.ssh/id_rsa $target_machine
$bindir/hmount
$bindir/vmount

echo
echo "Syncing ..."
p=/b/om/p/CRUZER
if [[ ! -d $p ]]; then
  p=$HOME/b/om/p/CRUZER
fi
if [[ ! -d $p ]]; then
  echo 'ERROR: Not found /b/om/p/CRUZER or $HOME/b/om/p/CRUZER'
  exit 1
fi
p=$(cd $p && pwd -P)
cmd="rsync -a --delete $p/ $target_machine:/b/om/p/CRUZER/"
echo "doing: $cmd"
$cmd
$bindir/humount
/usr/bin/ssh $target_machine 'rm -f .ssh/authorized_keys'

cp -p -f ~/.ssh/config.000 ~/.ssh/config

