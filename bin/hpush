#!/bin/bash

bindir=$(dirname $0)
target_machine='crondite.duckdns.org'
ifconfig -a|egrep 'inet .*192\.168\.10\.' >/dev/null 2>&1
if [[ $? == 0 ]]; then
  target_machine='192.168.10.180'
fi

printf "Push to $target_machine? (y/n): "
read yesno
if [[ $yesno != 'y' ]]; then
  exit 1
fi

/usr/bin/ssh-copy-id om@$target_machine
$bindir/hmount
$bindir/vmount

echo
echo "Syncing ..."
p=/b/om/p/CRUZER
if [[ ! -d $p ]]; then
  p=$HOME/b/om/p/CRUZER
fi
if [[ ! -d $p ]]; then
  echo 'ERROR: Not found /b/om/p/CRUZER or $HOME/b/om/p/CRUZER'
  exit 1
fi
cmd="rsync -a --delete $p/ om@$target_machine:/b/om/p/CRUZER/"
echo "doing: $cmd"
$cmd
$bindir/humount
/usr/bin/ssh om@$target_machine 'rm -f .ssh/authorized_keys'

