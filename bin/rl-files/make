#!/bin/bash

runit() {
    if [[ "$1" == '' ]] || [[ "$1" == '0'  ]] ; then
        docker exec -it -u om -w /home/om rl bash
    else
        docker exec -it -u om -w /home/om rl "$@"
    fi
}

if [[ "$1" == '0' ]]; then
    docker rm -f rl
    docker rmi -f myrl
fi



docker inspect rl > /dev/null 2>&1

if [ $? -eq 0 ]; then
    runit "$@"
    exit 0
fi

docker image inspect myrl > /dev/null 2>&1
if [ $? -ne 0 ]; then
    docker build -t myrl .
fi

h=rl
mkdir -p ~/ggg
rsync -a --delete ~/gcode/ ~/ggg/gcode/
docker run -itd --name $h -h $h \
    -p 3022:22 \
    -p 4022:4022 \
    -p 5022:5022 \
    -p 3128:3128 \
    -p 3129:3129 \
    -p 4343:4343 \
    myrl

umask 077
rm -rf ~/.ssh/rl
mkdir -p ~/.ssh/rl
ssh-keygen -t ed25519 -N '' -f ~/.ssh/rl/id_ed25519
docker cp ~/.ssh/rl/id_ed25519.pub rl:/tmp/pubkey

egrep '^Host[ \t]+rl$' ~/.ssh/config >/dev/null 2>&1
if [[ $? != 0 ]]; then
    cat <<"EOF" >>~/.ssh/config

Host rl
    Hostname 0.0.0.0
    Port 3022
    User om
    IdentityFile ~/.ssh/rl/id_ed25519

EOF
fi

#    -v ~/:/home/om/h \

if [[ -d ~/gcode ]]; then

    docker cp -a ~/gcode/ rl:/tmp/gcode/

    cat <<"EOF" | docker exec -u root -i rl bash -
umask 077
mkdir -p /home/om/.ssh
mv /tmp/pubkey /home/om/.ssh/authorized_keys
mv /tmp/gcode /home/om/gcode
chown -R om:om /home/om/gcode /home/om/.ssh
EOF

    cat <<"EOF" | docker exec -i -u om -w /home/om rl bash -
. gcode/bin/gcode.0
. .bashrc
gits

EOF

fi

runit "$@"
