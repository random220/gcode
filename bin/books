#!/bin/bash
myname=$(basename "$0")
vmx=/Users/omandal/b/VMs/rk-books.vmwarevm/rk-books.vmx
PORT=8080

vmip=''
main() {
    if [[ $myname == books ]]; then
        vmstart
        show_ssh_code
        exit 0
    elif [[ $myname == bookend ]]; then
        vmstop
    fi
}

show_ssh_code() {
cat <<__EOF__


# ======================================================

doit() {

umask 077
rm -rf ~/.ssh/books
mkdir -p ~/.ssh/books

cat <<EOF >~/.ssh/books/config
StrictHostKeyChecking=no
CheckHostIP=no
EscapeChar=~
UserKnownHostsFile=/dev/null
LogLevel ERROR

Host books
    User om
    HostName $vmip
    Port 22
    ControlPath ~/.ssh/books/ctrl-%l-to-%h
    ControlMaster auto
    ControlPersist 10m
    ServerAliveInterval 180
    LocalForward $PORT localhost:$PORT
EOF

ssh -t -t -F ~/.ssh/books/config books "pyweb $PORT"
}

doit

# ======================================================



__EOF__
}


vmstart() {
    vmrun start /Users/omandal/b/VMs/rk-books.vmwarevm/rk-books.vmx
    if [[ $? != 0 ]]; then
        exit $?
    fi
    while true; do
        ip=$(vmrun getGuestIPAddress "$vmx" 2>/dev/null)
        if [[ $ip =~ ^[0-9\.]+$ ]]; then
            vmip=$ip
            return 0
        fi
        sleep 1
    done
}

vmstop() {
    vmrun revertToSnapshot "$vmx" 00
}

main

