#!/bin/bash

host=con
docker rm -f $host
docker run -itd --name $host -h $host -p 8888:8888 ubuntu:22.04 bash

cat <<'EOF' | docker exec -i $host bash -
apt-get -y update
apt-get -y dist-upgrade
apt-get -y install git vim curl sudo tmux
useradd -s /bin/bash -m om
echo 'om ALL=(ALL:ALL) NOPASSWD: ALL' >/etc/sudoers.d/om

# https://docs.conda.io/en/latest/miniconda.html
cd /tmp
curl -sL -o a.sh https://repo.anaconda.com/miniconda/Miniconda3-py311_23.5.2-0-Linux-x86_64.sh
chmod a+x a.sh
./a.sh -b -p /opt/miniconda3    # -b : batch,  -p : prefix
rm -f a.sh
EOF

docker exec -i $host su - om -c '/opt/miniconda3/bin/conda init'

cat <<'EOF' | docker exec -i $host su - om -c bash -

mkdir -p ~/bin
cat <<'_EOF' >~/bin/jupe
#!/bin/bash

eval "$(/opt/miniconda3/bin/conda shell.bash hook)"

mkenv() {
    mkdir -p ~/x
    conda create -yqm --prefix ~/x/env jupyter
    conda activate ~/x/env
    conda install -yqm pandas numpy matplotlib scikit-learn
    conda deactivate
}

if [[ ! -d ~/x/env ]]; then
    mkenv
fi
conda activate ~/x/env
tmux new-session -d -s jupe jupyter notebook --no-browser --ip=0.0.0.0 --port=8888
sleep 1
jupyter notebook list

_EOF

chmod a+x ~/bin/jupe

mkdir -p ~/x
cd ~/x
~/bin/jupe
EOF


